{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HISTORICO SCI</title>
    <link rel="stylesheet" href="{% static 'css/tela_sci_historico.css' %}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Varela+Round">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
</head>
<body>
    {% include 'base/base.html' %}
    <div class="fundo-historico">
        <div class="historico-container">
            <div class="search-container">
                <input type="text" id="searchInput" placeholder="Buscar...">
            </div>
            <table class="historico-tabela">
                <thead>
                    <tr>
                        <th>Descrição</th>
                        <th>Sistema</th>
                        <th>Data</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="historicoTableBody">
                    {% for historico in historicos %}
                    <tr>
                        <td data-label="Chats">{{ historico.descricao }}</td>
                        <td data-label="Chats">{{ historico.sistema }}</td>
                        <td data-label="Data">{{ historico.sent|date:"d/m/Y" }}</td>
                        <td class="alinhar-fotos" data-label="Ações">
                            <a href="#"><img src="{% static 'media/view.svg' %}" alt="View" title="Visualizar"></a>
                            <button class="edit-btn" data-id="{{ historico.id }}" data-prompt="{{ historico.prompt }}" style="background:none; border:none; padding:0;">
                                <img src="{% static 'media/edit.svg' %}" alt="Editar" title="Editar" class="icon">
                            </button>
                            <button class="delete-btn" data-id="{{ historico.id }}" style="background:none; border:none; padding:0;">
                                <img src="{% static 'media/delete.svg' %}" alt="Deletar" title="Deletar" class="icon">
                            </button>
                        </td>                    
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div id="paginationControls" class="pagination-controls"></div>
        </div>
    </div>

    
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Editar Nome do Chat</h2>
            <form id="editForm" method="post" action="">
                {% csrf_token %}
                <input type="hidden" name="id" id="editId">
                <div>
                    <label for="editPrompt">Nome do Chat</label>
                    <input type="text" id="editPrompt" name="prompt">
                </div>
                <button type="submit">Salvar</button>
            </form>
        </div>
    </div>

    
    <div id="deleteModal" class="modal fade">
        <div class="modal-dialog modal-confirm">
            <div class="modal-content">
                <div class="modal-header flex-column">
                    <div class="icon-box">
                        <i class="material-icons">&#xE5CD;</i>
                    </div>						
                    <h4 class="modal-title w-100">Tem certeza?</h4>	
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                </div>
                <div class="modal-body">
                    <p>Você realmente deseja excluir o prompt ?</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        
        const editModal = document.getElementById('editModal');
        const span = document.getElementsByClassName('close')[0];
        const editBtns = document.getElementsByClassName('edit-btn');
        const editForm = document.getElementById('editForm');
        const editPromptInput = document.getElementById('editPrompt');
        const editIdInput = document.getElementById('editId');

        for (let btn of editBtns) {
            btn.onclick = function() {
                const id = this.getAttribute('data-id');
                const prompt = this.getAttribute('data-prompt');
                editPromptInput.value = prompt;
                editIdInput.value = id;
                editForm.action = "{% url 'sci_edit' 0 %}".replace('0', id);
                editModal.style.display = 'block';
            };
        }

        span.onclick = function() {
            editModal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == editModal) {
                editModal.style.display = 'none';
            }
        }

        
        function openDeleteModal(id) {
            $('#deleteModal').modal('show');
            document.getElementById('confirmDeleteBtn').setAttribute('data-id', id);
        }

        function deleteRecord() {
            const id = document.getElementById('confirmDeleteBtn').getAttribute('data-id');
            const formAction = "{% url 'sci_delete' '0' %}".replace('0', id);
            $.post(formAction, {
                csrfmiddlewaretoken: '{{ csrf_token }}'
            }).done(function() {
                location.reload(); 
            });
        }

        
        $(document).ready(function() {
            $('.delete-btn').on('click', function() {
                const itemId = $(this).data('id');
                openDeleteModal(itemId);
            });

            $('#confirmDeleteBtn').on('click', function() {
                deleteRecord();
            });
        });
    </script>
</body>
</html>
